---
title: "group_midus"
output:
  html_document: default
  pdf_document: default
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

## Dependencies

This notebook can be reproduced by installing the following R
packages: - knitr - dplyr ...

And by using the functions in the following files

```{r, include=FALSE}

#source("R/my_read_rda.R", local = knitr::knit_global())

```

# Reproducibility group project, BST270 2024

## Introduction

In this Rmarkdown file we will attempt to reproduce the figures, tables
and analyses presented in the paper [*Relation between Optimism and
Lipids in
Midlife*.](https://www.ajconline.org/article/S0002-9149(13)00388-3/pdf)

1.  Boehm, J. K., Williams, D. R., Rimm, E. B., Ryff, C., &
    Kubzansky, L. D. (2013). Relation between Optimism and Lipids in
    Midlife. The American Journal of Cardiology, 111(10), 1425-1431.
    <http://doi.org/10.1016/j.amjcard.2013.01.292>

In 1995, MIDUS survey data were collected from a total of 7,108
participants. The baseline sample was comprised of individuals from four
subsamples: (1) a national RDD (random digit dialing) sample
($n = 3,487$); (2) oversamples from five metropolitan areas in the U.S.
($n = 757$); (3) siblings of individuals from the RDD sample
($n = 950$); and (4) a national RDD sample of twin pairs ($n = 1,914$).
All eligible participants were non-institutionalized, English-speaking
adults in the contiguous United States, aged 25 to 74. All respondents
were invited to participate in a phone interview of approximately 30
minutes in length and complete 2 self-administered questionnaires
(SAQs), each of approximately 45 pages in length. In addition, the twin
subsample was administered a short screener to assess zygosity and other
twin-specific information. With funding provided by the National
Institute on Aging, a longitudinal follow-up of MIDUS I began in 2004.
Every attempt was made to contact all original respondents and invite
them to participate in a second wave of data collection. Of the 7,108
participants in MIDUS I, 4,963 were successfully contacted to
participate in another phone interview of about 30 minutes in length.
MIDUS II also included two self-administered questionnaires (SAQs), each
of about 55 pages in length, which were mailed to participants. The
overall response rate for the SAQs was 81%. Over 1,000 journal articles
have been written using MIDUS I and II data since 1995.

Here we attempt to reproduce the findings of [1] and critique the
reproducibility of the article. This particular article focuses only on
MIDUS II data, including biomarker data, and investigates the
relationship between optimism and lipids. The MIDUS II data and
supporting codebook and other documents can be downloaded
\href{https://www.icpsr.umich.edu/icpsrweb/ICPSR/studies/4652?archive=ICPSR&q=MIDUS+}{here}.
The data can be downloaded in multiple formats. The biomarker data can
be downloaded
\href{https://www.icpsr.umich.edu/icpsrweb/NACDA/studies/29282}{here}.

## Data Dictionary

This manuscript uses several variables from multiple data files. Some of
these variables don't have intuitive names and need to be manually
looked up either online or in the codebooks provided in the data
downloads. We generated a data dictionary to our understanding of the
naming conventions.

Load packages

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(DT)
#install.packages("gtsummary")

library(gtsummary)
```

We are trying to keep all functions well documented. This command allows
us to have package-like documentation for all of the functions.

```{r}
if (!require('devtools')) install.packages('devtools')
```

## Read data

First we load the data. 29282-0001-Data contains the analysis-associated
data, while 04652-0001-Data contains the midus clinical data.

```{r}
load('data/29282-0001-Data.rda')
load('data/04652-0001-Data.rda')
```

We have to merge the two tables based on the MIDUS II ID number

```{r}
data = inner_join(da04652.0001, da29282.0001, by = c("M2ID", "M2FAMNUM"),suffix = c('','.2'))
print(dim(data))
```

Data has 1054 rows at the beginning after merging the two tables. Now we
are going to try and reproduce the preprocessing steps such that we can
obtain the 990 individuals they used for the paper analysis.

## Wrangle data

### Step 0. Filter optimism variables

Optimism is assessed using the 6-item Life-Orientation test. In the
codebook we have found that B1SORIEN is the column with the results of the life orientation test. 
We excluded entries with -1 or non-integer values. 
We arbitrarily made this choice because we couln't find any indication in the docs.

Here we are filtering the rows to remove the individuals who do not have
an optimism score.

```{r}
# filter optimism variables
source("filter_optimism.R")
data_after_optimism_filtering <- Filter_optimism(data)
print(dim(data_after_optimism_filtering))
```

We are left with 1046 samples that optimism data.

Secondly, we clean the columns relative to lipids (Total cholesterol,
HDL, LDL, triglicerydes).

### Step 1 Filter lipid measurements

```{r}
# filter and clean lipid measurement columns
source("filter_lipids.R")
data_after_lipid_filtering <- Filter_lipids(data)
print(dim(data_after_lipid_filtering))
```

After filtering lipid measurements, we have 1043 rows left

```{r}
temp_data <- inner_join(data_after_optimism_filtering,
                        data_after_lipid_filtering, by = "M2ID")

print(dim(temp_data))
```

1035 after filtering for both lipids and optimism

### Step 2 Filter pathway variables

```{r}
# filter pathway varibales
source("filter_pathway.R")
data_after_pathway_filtering <- filter_pathway(data)
print(dim(data_after_pathway_filtering))
```

We are left with 1048 samples

```{r}
temp_data <- inner_join(data_after_optimism_filtering,
                        data_after_lipid_filtering, by = "M2ID") %>%
              inner_join(data_after_pathway_filtering, by = "M2ID")

print(dim(temp_data))
```


1031 after pathway filtering.

The drinking variable was the hardest one to deal with, because there are multiple
columns dedicated to it, and also the numbers in there are hard to understand. 


### Step 3 Filter potential confounders

Finally we filter the potential confounders, such as age, sex, income..

```{r}
# filter confounders
source("filter_confounders.R")
data_after_confounder_filtering = Filter_confounders(data)
print(dim(data_after_confounder_filtering))
```

```{r}
temp_data <- inner_join(data_after_optimism_filtering,
                        data_after_lipid_filtering, by = "M2ID") %>%
              inner_join(data_after_pathway_filtering, by = "M2ID") %>% 
  inner_join(data_after_confounder_filtering, by = "M2ID")

print(dim(temp_data))
```

Here we are left with 996 individuals

Let's keep only the columns of interest

```{r}
full_data <- inner_join(data_after_optimism_filtering,
                        data_after_lipid_filtering, by = "M2ID") %>%
    inner_join(data_after_confounder_filtering, by = "M2ID") %>%
    inner_join(data_after_pathway_filtering, by = 'M2ID')

print(dim(full_data))

# all_columns = c(optimism_columns, lipid_columns, pathway_columns, confounder_columns)
#View(data_after_fc[,all_columns])
```

The data seems to be complete, but the documentation or methods section does 
not give full details on which columns they are using and how they filter them.


## Figure 1

First, we attempt to reproduce Figure 1. Figure 1 shows the frequency
distribution of 990 optimism scores (mean +- SD: 23.95 +- 4.69), with
black representing the lowest tertile of optimism (6 to 22), gray,
middle tertile of optimism (23 to 26), and white, highest tertile of
optimism (27 to 30)

```{r}
mean(full_data$B1SORIEN)
sd(full_data$B1SORIEN)
```

We get mean (24.008 +- 4.69), so the mean is slightly higher, but the SD is comparable.
Tertiles: 22 and 27 so we probably have fewer patients with lower optimism score.

```{r}
#generate figure 1
source("figure1.R")
figure1(full_data) #print histogram

```
We were able to reproduce the figure, but given the discrepancies in the number of patients
the tertiles are not exactly the same. 

We do not know exactly why, but the cholesterol column seems to have some "weird" values
that might explain the difference in the population.


## Table 1

We then proceed to reproduce table 1. We are gonna split it in different
chunks, based on the lipid/confounder/pathway groups.

### Pathway

```{r}

source("pathway_tableone.R")
pathway_tableone(full_data)
exercise_tbl(full_data)

```
We have similar resutls for the smoking status, but different for drinking status. 


### Confounder
```{r}

truncate_decimal <- function(x, digits) {
  factor <- 10^digits
  ifelse(x >= 0, floor(x * factor) / factor, ceiling(x * factor) / factor)
}

# generate table 1

source("generate_table1_confounding.R")
generate_confounding_table1(full_data)
```

```{r}

library(dplyr)
library(tidyr)
# Helper function for formatting percentages and statistics
format_table <- function(cont_tab) {
    row_percents <- prop.table(cont_tab, margin = 1) * 100
    col_percents <- prop.table(cont_tab, margin = 2) * 100
    
    formatted_table <- NULL
    for(i in 1:nrow(cont_tab)) {
        formatted_table <- rbind(
            formatted_table,
            col_percents[i, ],  # Column percentages
            row_percents[i, ]   # Row percentages
        )
    }
    # Create row names
    row_labels <- rep(rownames(cont_tab), each = 2)
    row_types <- rep(c("(Column %)", "(Row %)"), length(rownames(cont_tab)))
    rownames(formatted_table) <- paste(row_labels, row_types)
    
    return(as.data.frame(formatted_table))
}

generate_confounding_table1 <- function(full_data) {
    # Optimism categories
    tertile1 <- quantile(full_data$B1SORIEN, 1/3)
    tertile2 <- quantile(full_data$B1SORIEN, 2/3)
    
    full_data$optimism_category <- factor(case_when(
        full_data$B1SORIEN < tertile1 ~ "low",
        full_data$B1SORIEN >= tertile1 & full_data$B1SORIEN < tertile2 ~ "moderate",
        full_data$B1SORIEN >= tertile2 ~ "high"
    ), levels = c("low", "moderate", "high"))
    
    # Initialize final table
    final_table <- data.frame(Variable = character(),
                              Statistic = character(),
                              Value = character())
    
    # Age summary
    age_summary <- full_data %>% 
        group_by(optimism_category) %>% 
        summarize(mean_sd = sprintf("%.2f ± %.2f", mean(age), sd(age))) %>% 
        pivot_longer(cols = everything(), names_to = "Statistic", values_to = "Value")
    age_summary$Variable <- "Age"
    final_table <- rbind(final_table, age_summary)
    
    # Education
  # Assuming education_table is a matrix or data frame
  education_table <- format_table(table(full_data$education_categorical, full_data$optimism_category))
  
  # Convert the matrix to a data frame for easier manipulation
  education_df <- as.data.frame(as.table(as.matrix(education_table)))
  
  # Rename columns to match desired structure
  colnames(education_df) <- c("Statistic", "Optimism_Category", "Value")
  
  # Add the `Variable` column to all rows
  education_df <- education_df %>%
    mutate(Variable = "Education")
    final_table <- rbind(final_table, education_table)
    
    # Race
    race_table <- format_table(table(full_data$race, full_data$optimism_category))
    race_table <- tibble(Variable = "Race",
                         Statistic = rownames(race_table),
                         Value = as.character(unlist(race_table)))
    final_table <- rbind(final_table, race_table)
    
    # Gender
    gender_table <- format_table(table(full_data$sex, full_data$optimism_category))
    gender_table <- tibble(Variable = "Gender",
                           Statistic = rownames(gender_table),
                           Value = as.character(unlist(gender_table)))
    final_table <- rbind(final_table, gender_table)
    
    # Chronic condition
    chronic_table <- format_table(table(full_data$chronic_condition, 
                                        full_data$optimism_category))
    chronic_table <- tibble(Variable = "Chronic Condition",
                            Statistic = rownames(chronic_table),
                            Value = as.character(unlist(chronic_table)))
    final_table <- rbind(final_table, chronic_table)
    
    # Income and visit interval
    interval_income_summary <- full_data %>% 
        group_by(optimism_category) %>% 
        summarize(
            visit_interval = sprintf("%.2f ± %.2f", mean(visit_interval), sd(visit_interval)),
            household_income = sprintf("%.2f ± %.2f", mean(household_income), sd(household_income))
        ) %>% 
        pivot_longer(cols = everything(), names_to = "Statistic", values_to = "Value")
    interval_income_summary$Variable <- "Income and Visit Interval"
    final_table <- rbind(final_table, interval_income_summary)
    
    # Blood pressure medication
    bp_table <- table(full_data$blood_pressure_med, full_data$optimism_category)
    bp_table <- format_table(bp_table)
    bp_table <- tibble(Variable = "Blood Pressure Medication",
                       Statistic = rownames(bp_table),
                       Value = as.character(unlist(bp_table)))
    final_table <- rbind(final_table, bp_table)
    
    # Negative affect
    negative_affect_summary <- full_data %>% 
        group_by(optimism_category) %>% 
        summarize(mean_sd = sprintf("%.2f ± %.2f", 
                                    mean(negative_affect), 
                                    sd(negative_affect))) %>% 
        pivot_longer(cols = everything(), names_to = "Statistic", values_to = "Value")
    negative_affect_summary$Variable <- "Negative Affect"
    final_table <- rbind(final_table, negative_affect_summary)
    
    return(final_table)
}

generate_confounding_table1(full_data)

```

Results are pretty similar, however we are unable to replicate the chronic conditions 
results. We could not figure out how to process the data, because we use the same 
variables they refer to in the paper, but the percentages are different.



```{r}
# generate table 1 based on the lipid variables
source("table_1_lipid.R")
table_1_lipid(full_data)
```

We get similar results, although for total cholesterol they might have kept all values, 
maybe that is why we get different results.


## Table 2

We then proceed to reproduce table 2. They don't specify how the correlations
and p-values are calculated, so we'll assume Spearman correlation and
HC3 standard errors

```{r}
fig2_cols <- c("Optimism", "Age", "Gender", "Race", "Education", "Income",
               "Interval between assessments", "Chronic conditions",
               "Blood pressure medication", "Body mass index", "Smoking status",
               "Alcohol consumption", "Prudent diet", "Regular exercise",
               "Negative affect")
cor_data <- full_data %>%
    mutate(Optimism = B1SORIEN,
           Age = as.numeric(age),
           Gender = case_when(sex == '(1) Male' ~ 0,
                              sex == '(2) Female' ~ 1),
           Race = case_when(race == 'White' ~ 0,
                            race == 'Nonwhite' ~ 1),
           Education = education_categorical,
           Income = household_income,
           `Interval between assessments` = visit_interval,
           `Chronic conditions` = case_when(chronic_condition == '(0) No' ~ 0,
                                            chronic_condition == '(1) Yes' ~ 1),
           `Blood pressure medication` = case_when(blood_pressure_med == '(2) No' | blood_pressure_med == '2' ~ 0,
                                                   blood_pressure_med == '1' ~ 1),
           `Body mass index` = BMI,
           `Smoking status` = case_when(smoking_status == '(1) current smoker' ~ 1,
                                        smoking_status == '(2) past smoker' ~ 2,
                                        smoking_status == '(3) never smoker' ~ 3),
           `Alcohol consumption` = drinks_per_day,
           `Prudent diet` = prudent_diet_score,
           `Regular exercise` = case_when(regular_exercise == '(2) No' ~ 0,
                                          regular_exercise == '(1) Yes' ~ 1),
           `Negative affect` = negative_affect) %>%
    select(all_of(fig2_cols))

results_df <- data.frame(matrix(ncol = 3, nrow = length(fig2_cols) - 1))
colnames(results_df) <- c("Characteristic", "r", "p")
for (i in seq(fig2_cols[-1])) {
    colname <- fig2_cols[-1][i]
    cor_val <- c(cor(cor_data[colname], cor_data$Optimism, method = 'pearson'))
    lm_model <- lm(cor_data$Optimism ~ unlist(cor_data[colname]))
    pval <- coef(summary(lm_model))[2, 'Pr(>|t|)']
    results_df$Characteristic[i] <- colname
    results_df$r[i] <- cor_val
    results_df$p[i] <- pval
}

results_df <- results_df %>%
    mutate(r = round(r, 2),
           p = case_when(p < 0.0001 ~ "<0.0001",
                            p < 0.001 ~ "<0.001",
                            TRUE ~ as.character(round(p, 2))))

knitr::kable(results_df)

```

We get very similar results, so even if the population is slightly different, we do not
arrive at different conclusions. However, for Chronic conditions we do get different results
which is in line with the different values we saw for table 1.



## Table 5

```{r}
#Filter data for table 5
source("lipid_risk.R")
Filter_lipids_bad(data) 
```
